<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    
    <title>JHChabran | Setuping tests for a Chrome Extension with CoffeeScript</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- styles -->
    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/pygments/default.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/font-awesome.css">
 
    <!--  fonts, loaded first because it doesn't look nice without -->
    <script type="text/javascript"
src="//use.typekit.net/kcf8mke.js"></script>
    <script
type="text/javascript">try{Typekit.load();}catch(e){}</script>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
  </head>

  <body>

    <div class="container-narrow">
      <div class="masthead">
  <ul class="nav nav-pills pull-right app-menu">
    <li><a href="/">Home</a></li>
    <li><a href="/blog/">Blog</a></li>
    <!-- <li><a href="#/">About</a></li> -->
  </ul>
  <a href="/"><h1 class="">JHChabran</h1></a>
  
    <h4 class="muted">Thoughts on Ruby, CoffeeScript and Vim from a passionate developer.</h4>
  
</div>

<hr>

    
      <div class="row">
  <div class="span8">
    <h1><a href="/blog/2012/11/27/testing-a-chrome-extension">Setuping tests for a Chrome Extension with CoffeeScript</a></h2>
    <h4>
      Posted on November 27, 2012
      
      
      in <a href="/categories/chrome">Chrome</a>
      
      
    </h4>
    <hr/>

    <div class="post-content">
      <p>So we've previously seen how to bootstrap a chrome extension with CoffeeScript.
The next step is about adding testing support. Even if it's a simple
extension, the whole process of reloading the extension in the browser
to manually test a feature is plain boring and error prone.</p>

<p>To illustrate this, TabSwitcher will be used as an example, covering
basic tasks like setuping the test environment to load the code that
requires testing.</p>

<p>This post assume you're already comfortable with testing, if you're not
you will find resources on TODO.</p>

<h2>Setuping the tests</h2>

<p>Before anything, a test framework need to be chosen. A popular choice
would be Jasmine.
First step, choosing a testing framework. I didn't want to spend hours
studying each framework so I went with a popular one : Jasmine.
Relying on Node package manager is probably the simplest way to install
it:</p>

<p>Tests will live under the spec directory (or test, it's a matter of
taste) :</p>

<p>And create a file that will contain our tests.</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nx">describe</span> <span class="s">&quot;Fuzzy&quot;</span><span class="p">,</span> <span class="o">-&gt;</span> 
  <span class="nx">it</span> <span class="s">&quot;should fail&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">expect</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</code></pre>
</div>


<p>Run it with</p>

<p>Our test fails as expected, we can now write some expectactions.</p>

<h2>Loading the code we want to test</h2>

<p>Before testing anything we need to load the code that requires testing.</p>

<p>On one hand, the chrome extension code runs in a browser, scripts are loaded by the html
pages, through <code>script</code> tags. On the other hand the jasmine-node binary we installed
runs the code in a Node.js environment environment. Code loading is
achieved through the <code>require</code> function. Defining which objects or
functions a node module exports is done through the exports object.</p>

<p>Given <code>src/fuzzy.coffee</code> defines two public functions, <code>match</code>
and <code>sortByMatchingScore</code> :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nv">exports.match = </span><span class="nx">match</span>  
<span class="nv">exports.sortByMatchingScore = </span><span class="nx">sortByMatchingScore</span>
</code></pre>
</div>


<p>This code will export these two function, making them available to our
tests, as shown below in <code>spec/fuzzy_spec.coffee</code>:</p>

<div class="highlight"><pre><code class="coffeescript"><span class="nv">f = </span><span class="nx">require</span> <span class="s">&#39;../src/fuzzy&#39;</span>

<span class="nx">describe</span> <span class="s">&quot;Fuzzy&quot;</span><span class="p">,</span> <span class="o">-&gt;</span> 
  <span class="nx">it</span> <span class="s">&quot;should call match&quot;</span><span class="p">.</span> <span class="o">-&gt;</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">match</span> <span class="s">&quot;http://google.com&quot;</span><span class="p">,</span> <span class="s">&quot;ggl&quot;</span>
</code></pre>
</div>


<p>We run it again and we got it all green.</p>

<p>But that won't work in the extension because <code>exports</code> isn't
defined. To solve that, assigning <code>window</code> to <code>`exports</code> will do
the trick.</p>

<p>And now we got our code both running in specs and in the extension.</p>

<h2>Isolating the code that need to be tested.</h2>

<p>Extensions makes usage of chrome.* apis. Since we can't use them from
our tests we go around them by design or mock them. For now let's just
keep things simple, the later will be described in another post.</p>

<p>Most of the time we can avoid embedding calls to the chrome api by
simply separating concerns. In the case of Tabswitcher, the fuzzy
algorithm's only responsability is to discrimate and sort urls with a short
string.</p>

<p>The two key functions prototypes are :</p>

<div class="highlight"><pre><code class="coffeescript"><span class="c1"># Given an array of urls and an abbreviation</span>
<span class="c1"># Returns an array of matching informations, sorted by their scores.</span>
<span class="nv">sortByMatchingScore = </span><span class="nf">(urls, abbrev)-&gt;</span>  
  <span class="c1"># ...</span>

<span class="c1"># Given a string and an abbreviation</span>
<span class="c1"># Returns a hash of matching informations, </span>
<span class="c1"># with &#39;score&#39; is an float between 0 and abbrev.length varying upon how</span>
<span class="c1">#              much abbrev match string</span>
<span class="c1">#      &#39;indexes&#39; is an array with the the positions of the chars in the string</span>
<span class="nv">match = </span><span class="nf">(string, abbrev, offset)-&gt;</span>
  <span class="c1"># ...</span>
</code></pre>
</div>


<p>Ok, no mocking needed !</p>

    </div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'jhchabran'; 

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
  <div class="offset1 span3">
    <div class="blog-icons">
<a href="http://feeds.feedburner.com/jhchabran">
  <i class="icon-rss"></i>
</a>
<a href="http://twitter.com/jhchabran">
  <i class="icon-twitter"></i>
</a>
<a href="http://github.com/jchabran">
  <i class="icon-github"></i>
</a>
<a href="http://www.linkedin.com/profile/view?id=25800986&trk=tab_pro">
  <i class="icon-linkedin"></i>
</a>
</div>
<h3>Categories</h3>
<a href="/categories/chrome"><strong>Chrome</strong></a> (2)<br /><a href="/categories/coffeescript"><strong>CoffeeScript</strong></a> (1)<br /><a href="/categories/osx"><strong>OSX</strong></a> (1)<br /><a href="/categories/rails"><strong>Rails</strong></a> (2)<br /><a href="/categories/rant"><strong>Rant</strong></a> (1)<br /><a href="/categories/vim"><strong>Vim</strong></a> (1)<br /><a href="/categories/ruby"><strong>Ruby</strong></a> (1)<br />
<h3>Tags</h3>

            <span style="font-size: 211%">
              <a href="/tags/chrome/" title="3 posts">Chrome</a>
            </span>
          
            <span style="font-size: 143%">
              <a href="/tags/coffescript/" title="2 posts">CoffeScript</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/coffeescript/" title="1 post">CoffeeScript</a>
            </span>
          
            <span style="font-size: 143%">
              <a href="/tags/javascript/" title="2 posts">Javascript</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/osx/" title="1 post">OSX</a>
            </span>
          
            <span style="font-size: 143%">
              <a href="/tags/opensource/" title="2 posts">OpenSource</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/productivity/" title="1 post">Productivity</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/project/" title="1 post">Project</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/rspec/" title="1 post">RSpec</a>
            </span>
          
            <span style="font-size: 143%">
              <a href="/tags/rails/" title="2 posts">Rails</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/rant/" title="1 post">Rant</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/ruby/" title="1 post">Ruby</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/tdd/" title="1 post">TDD</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/talk/" title="1 post">Talk</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/vim/" title="1 post">Vim</a>
            </span>
          
<h3>Archives</h3>
<a href="/2012/11"><strong>November 2012</strong></a> (2)<br /><a href="/2012/09"><strong>September 2012</strong></a> (1)<br /><a href="/2012/06"><strong>June 2012</strong></a> (1)<br /><a href="/2012/05"><strong>May 2012</strong></a> (1)<br /><a href="/2011/12"><strong>December 2011</strong></a> (1)<br /><a href="/2011/09"><strong>September 2011</strong></a> (1)<br /><a href="/2011/07"><strong>July 2011</strong></a> (1)<br /><a href="/2010/03"><strong>March 2010</strong></a> (1)<br />

  </div>
</div>




      <hr>

<div class="footer">
  <p>&copy; JHCHABRAN 2012  
  <a class='pull-right' title="Real Time Web Analytics" href="http://getclicky.com/100551085"><img alt="Real Time Web Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a></p>
</div>


    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery.js"></script>
<script src="/js/application.js"></script>
<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36508562-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>
<script type="text/javascript">
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(100551085);
(function() {
    var s = document.createElement('script');
      s.type = 'text/javascript';
        s.async = true;
          s.src = '//static.getclicky.com/js';
            ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100551085ns.gif" /></p></noscript>

  </body>
</html>
